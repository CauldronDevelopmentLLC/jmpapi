options:
  http-addresses: [127.0.0.1:7000]
  http-root: /usr/share/jmpapi/http
  session-sql: CALL GetSession(%(id)s)

api:
  /api:
    GET:
      handler: api
      help: Returns a description of this API.

  /login/:provider:
    GET:
      handler: login
      redirect: /admin.html
      args:
        provider:
          optional: true
          enum: [list, google, facebook, github]
          help: The OAuth2 login provider.
      sql: >
        CALL Login(%(id)s, %(provider)s, %(provider_id)s, %(user)s, %(name)s,
          %(avatar)s)

  /logout:
    PUT:
      handler: logout
      sql: CALL Logout(%(id)s)
      help: Close the currently logged in session.

  /users:
    GET:
      return: list
      sql: >
        SELECT id, provider, provider_id, name, avatar, email, created,
          last_used FROM jmpapi_users
      help: Returns a list of all users.

  /users/:id:
    DELETE:
      allow: [$admin]
      return: ok
      sql: DELETE FROM jmpapi_users WHERE id = %(id)s
      help: Delete an existing user.
      args:
        id: {help: User ID}

  /users/:id/groups:
    GET:
      allow: [$admin]
      return: list
      sql: >
        SELECT g.name, COUNT(ug.uid) member FROM jmpapi_groups g
          LEFT JOIN jmpapi_user_groups ug ON ug.gid = g.id AND ug.uid = %(id)s
          GROUP BY g.name
      help: Get the list of groups with user membership.

  /users/:id/groups/:group:
    PUT:
      allow: [$admin]
      return: ok
      sql: >
        INSERT INTO jmpapi_user_groups (uid, gid)
          SELECT %(id)s, id FROM jmpapi_groups WHERE name = %(group)s
      help: Add a user to a group.

    DELETE:
      allow: [$admin]
      return: ok
      sql: >
        DELETE FROM jmpapi_user_groups
          WHERE uid = %(id)s AND gid IN
            (SELECT id FROM jmpapi_groups WHERE name = %(group)s)
      help: Remove a user from a group.

  /groups:
    GET:
      allow: [$admin]
      return: list
      sql: SELECT name FROM jmpapi_groups
      help: Returns the list of groups.

  /groups/:group:
    PUT:
      allow: [$admin]
      return: ok
      sql: INSERT INTO jmpapi_groups (name) VALUES (%(group)s)
      help: Create a new group.
      args:
        group: {help: The name of the new group.}

    DELETE:
      allow: [$admin]
      return: ok
      sql: DELETE FROM jmpapi_groups WHERE name = %(group)s AND name != 'admin'
      help: Delete a group.
      args:
        group: {help: The name of the group.}

  /groups/:group/users:
    GET:
      allow: [$admin]
      return: list
      sql: >
        SELECT uid id, provider, provider_id, u.name, avatar, created, last_used
          FROM jmpapi_user_groups ug
          JOIN jmpapi_groups g ON g.id = ug.gid AND g.name = %(group)s
          JOIN jmpapi_users u ON u.id = ug.uid
      help: Returns a list of users in a group.
